ðŸ“¦
2816 /src/index.js.map
2341 /src/index.js
1125 /src/disassemble.js.map
914 /src/disassemble.js
3660 /src/exception.js.map
4047 /src/exception.js
919 /src/intercept.js.map
788 /src/intercept.js
210 /src/logger.js.map
50 /src/logger.js
557 /src/maps.js.map
353 /src/maps.js
9426 /src/memory.js.map
9580 /src/memory.js
856 /src/patch.js.map
702 /src/patch.js
211 /src/ping.js.map
47 /src/ping.js
1268 /src/register.js.map
1157 /src/register.js
3216 /src/stoppoint.js.map
2958 /src/stoppoint.js
âœ„
{"version":3,"file":"index.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/index.ts"],"names":[],"mappings":"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"}
âœ„
import { log } from "./logger.js";
import { ping } from "./ping.js";
import { scanStrings, read, readString, write, writeString, readBytes, writeBytes, freeze, unfreeze, firstScan, nextScan, clearScanState, getScanResults } from "./memory.js";
import { addStoppoint, removeStoppoint } from "./stoppoint.js";
import { disassemble } from "./disassemble.js";
import { readRegister, writeRegister } from "./register.js";
import { initExceptionHandler } from "./exception.js";
import { intercept, detachInterception, detachAllInterceptors } from "./intercept.js";
import { patch } from "./patch.js";
import { getMemoryMaps } from "./maps.js";
rpc.exports = {
    log: (message) => log(message),
    ping: () => ping(),
    scanStrings: (targetValue, addresses) => scanStrings(targetValue, addresses),
    read: (address, width = 4, signed = false) => read(address, width, signed),
    write: (address, value, width = 4, signed = false) => write(address, value, width, signed),
    readString: (address, maxLength = 256) => readString(address, maxLength),
    writeString: (address, value) => writeString(address, value),
    addStoppoint: (address, mode, size) => addStoppoint(address, mode, size),
    removeStoppoint: (address, mode) => removeStoppoint(address, mode),
    disassemble: (address, count) => disassemble(address, count),
    readBytes: (address, length) => readBytes(address, length),
    writeBytes: (address, bytes) => writeBytes(address, bytes),
    readRegister: (id) => readRegister(id),
    writeRegister: (id, value) => writeRegister(id, value),
    freeze: (address) => freeze(address),
    unfreeze: (address) => unfreeze(address),
    patch: (address, operations) => patch(address, operations),
    intercept: (address, codeInjection) => intercept(address, codeInjection),
    detachInterception: (address) => detachInterception(address),
    detachAllInterceptors: () => detachAllInterceptors(),
    getMemoryMaps: () => getMemoryMaps(),
    hexdump: (address, length) => hexdump(ptr(address), { length: length }),
    firstScan: (targetValue, width = 4, signed = false) => firstScan(targetValue, width, signed),
    nextScan: (targetValue) => nextScan(targetValue),
    clearScanState: () => clearScanState(),
    getScanResults: (page = 1, pageSize = 100) => getScanResults(page, pageSize),
};
initExceptionHandler();
âœ„
{"version":3,"file":"disassemble.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/disassemble.ts"],"names":[],"mappings":"AAMA,SAAS,UAAU,CAAC,OAAe;IAC/B,MAAM,KAAK,GAAG,OAAO,CAAC,iBAAiB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC;IACtD,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC;AACrD,CAAC;AAED,MAAM,CAAC,MAAM,WAAW,GAAG,CAAC,OAAe,EAAE,KAAa,EAA6B,EAAE;IACrF,MAAM,YAAY,GAA8B,EAAE,CAAC;IAEnD,MAAM,WAAW,GAAG,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC;IAEpD,YAAY,CAAC,IAAI,CAAC;QACd,OAAO,EAAE,WAAW,CAAC,OAAO,CAAC,QAAQ,EAAE;QACvC,MAAM,EAAE,UAAU,CAAC,WAAW,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;QAClD,QAAQ,EAAE,WAAW,CAAC,QAAQ,EAAE;KACnC,CAAC,CAAC;IAEH,IAAI,kBAAkB,GAAG,WAAW,CAAC;IAErC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,EAAE,EAAE;QAC5B,MAAM,eAAe,GAAG,WAAW,CAAC,KAAK,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;QACnE,YAAY,CAAC,IAAI,CAAC;YACd,OAAO,EAAE,eAAe,CAAC,OAAO,CAAC,QAAQ,EAAE;YAC3C,MAAM,EAAE,UAAU,CAAC,eAAe,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;YACtD,QAAQ,EAAE,eAAe,CAAC,QAAQ,EAAE;SACvC,CAAC,CAAC;QACH,kBAAkB,GAAG,eAAe,CAAC;KACxC;IAED,OAAO,YAAY,CAAC;AACxB,CAAC,CAAA"}
âœ„
function _getOffset(address) {
    const range = Process.getRangeByAddress(ptr(address));
    return (ptr(address).sub(range.base)).toString();
}
export const disassemble = (address, count) => {
    const instructions = [];
    const instruction = Instruction.parse(ptr(address));
    instructions.push({
        address: instruction.address.toString(),
        offset: _getOffset(instruction.address.toString()),
        mnemonic: instruction.toString(),
    });
    let currentInstruction = instruction;
    for (let i = 1; i < count; i++) {
        const nextInstruction = Instruction.parse(currentInstruction.next);
        instructions.push({
            address: nextInstruction.address.toString(),
            offset: _getOffset(nextInstruction.address.toString()),
            mnemonic: nextInstruction.toString(),
        });
        currentInstruction = nextInstruction;
    }
    return instructions;
};
âœ„
{"version":3,"file":"exception.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/exception.ts"],"names":[],"mappings":"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"}
âœ„
import { usedBreakpointSlots, watchpoints, StoppointMode, removeBreakpoint, removeWatchpoint } from "./stoppoint.js";
export let currentContext = null;
export function getContext() {
    return currentContext;
}
function getMemoryAccessFromInstruction(ctx, instruction) {
    for (const operand of instruction.operands) {
        if (operand.type === 'mem') {
            const memOp = operand.value;
            let address;
            address = ctx[memOp.base].add(memOp.disp);
            console.log(`Memory access at ${address}, operation: ${operand.access}`);
            return {
                address: address,
                operation: operand.access
            };
        }
    }
    return null;
}
export function initExceptionHandler() {
    Process.setExceptionHandler(e => {
        console.log("EHI! Exception:", JSON.stringify(e, null, 2));
        currentContext = e.context;
        const accessedMemory = getMemoryAccessFromInstruction(e.context, Instruction.parse(e.address));
        const thread = Process.enumerateThreads()[0];
        if (Process.getCurrentThreadId() === thread.id && ['breakpoint', 'single-step'].includes(e.type)) {
            const instruction = Instruction.parse(e.address);
            console.log(`Instruction: ${instruction.toString()} at ${e.address}`);
            console.log(`=== Handler got ${e.type} exception at ${e.context.pc} ===`);
            if (usedBreakpointSlots.has(e.address.toString())) {
                console.log(`Breakpoint hit at ${e.address}`);
                const slot = usedBreakpointSlots.get(e.address.toString());
                removeBreakpoint(e.address.toString());
                send({
                    type: 'breakpoint',
                    address: e.address,
                    slot: slot
                });
                console.log(`Sent breakpoint event`);
            }
            else {
                const memAccess = getMemoryAccessFromInstruction(e.context, instruction);
                if (memAccess) {
                    const info = watchpoints.get(memAccess.address.toString());
                    if (info && (info.mode === memAccess.operation ||
                        info.mode === StoppointMode.ReadWrite ||
                        memAccess.operation === StoppointMode.ReadWrite)) {
                        removeWatchpoint(memAccess.address.toString());
                        send({
                            type: 'watchpoint',
                            address: memAccess.address,
                            operation: memAccess.operation,
                            size: info.size,
                            slot: info.slot,
                            pc: e.context.pc
                        });
                    }
                    else {
                        const currentInstruction = Instruction.parse(e.context.pc);
                        e.context.pc = currentInstruction.next;
                        return true;
                    }
                }
                else {
                    const currentInstruction = Instruction.parse(e.context.pc);
                    e.context.pc = currentInstruction.next;
                    return true;
                }
            }
            console.log("Waiting for resume message");
            var op = recv('resume', (msg) => {
                console.log(`Received resume message: ${msg}`);
            });
            op.wait();
            console.log("Resume message received");
            currentContext = null;
            return true;
        }
        else if (e.type === 'access-violation') {
            console.log(`Access violation at ${e.memory.address} is in frozen address`);
            const currentInstruction = Instruction.parse(e.context.pc);
            e.context.pc = currentInstruction.next;
            return true;
        }
        else {
            console.error(`Unknown exception type: ${e.type}`);
            // Not our fault, let the system handle it
            return false;
        }
    });
}
âœ„
{"version":3,"file":"intercept.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/intercept.ts"],"names":[],"mappings":"AAIA,MAAM,YAAY,GAAoC,IAAI,GAAG,EAAE,CAAC;AAEhE,MAAM,UAAU,SAAS,CAAC,OAAe,EAAE,aAA4B;IACnE,kBAAkB,CAAC,OAAO,CAAC,CAAC;IAE5B,MAAM,WAAW,GAAG,WAAW,CAAC,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE;QACjD,IAAI;YACA,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;SAC5B;QAAC,OAAO,KAAK,EAAE;YACZ,OAAO,CAAC,KAAK,CAAC,oCAAoC,OAAO,GAAG,EAAE,KAAK,CAAC,CAAC;SACxE;IACL,CAAC,CAAC,CAAC;IACH,YAAY,CAAC,GAAG,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;AAC3C,CAAC;AAED,MAAM,UAAU,kBAAkB,CAAC,OAAe;IAC9C,MAAM,WAAW,GAAG,YAAY,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;IAC9C,IAAI,WAAW,EAAE;QACb,WAAW,CAAC,MAAM,EAAE,CAAC;QACrB,YAAY,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;KAChC;AACL,CAAC;AAED,MAAM,UAAU,qBAAqB;IACjC,KAAK,MAAM,CAAC,OAAO,EAAE,WAAW,CAAC,IAAI,YAAY,CAAC,OAAO,EAAE,EAAE;QACzD,WAAW,CAAC,MAAM,EAAE,CAAC;KACxB;IACD,YAAY,CAAC,KAAK,EAAE,CAAC;AACzB,CAAC"}
âœ„
const interceptors = new Map();
export function intercept(address, codeInjection) {
    detachInterception(address);
    const interceptor = Interceptor.attach(ptr(address), function () {
        try {
            eval(codeInjection.code);
        }
        catch (error) {
            console.error(`Error executing injected code at ${address}:`, error);
        }
    });
    interceptors.set(address, interceptor);
}
export function detachInterception(address) {
    const interceptor = interceptors.get(address);
    if (interceptor) {
        interceptor.detach();
        interceptors.delete(address);
    }
}
export function detachAllInterceptors() {
    for (const [address, interceptor] of interceptors.entries()) {
        interceptor.detach();
    }
    interceptors.clear();
}
âœ„
{"version":3,"file":"logger.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/logger.ts"],"names":[],"mappings":"AAAA,MAAM,UAAU,GAAG,CAAC,OAAe;IAC/B,GAAG,CAAC,OAAO,CAAC,CAAC;AACjB,CAAC"}
âœ„
export function log(message) {
    log(message);
}
âœ„
{"version":3,"file":"maps.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/maps.ts"],"names":[],"mappings":"AAMA,MAAM,UAAU,aAAa;IACzB,IAAI,MAAM,GAAG,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;IAC5C,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,KAAK,EAAE,EAAE;QAC3B,IAAI,CAAC,KAAK,CAAC,IAAI;YAAE,OAAO,KAAK,CAAC;QAC9B,OAAO,IAAI,CAAC;IAChB,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;QACf,IAAI,EAAE,KAAK,CAAC,IAAK,CAAC,IAAI;QACtB,YAAY,EAAE,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE;QACnC,UAAU,EAAE,KAAK,CAAC,UAAU,CAAC,QAAQ,EAAE;KAC1C,CAAC,CAAC,CAAC;AACR,CAAC"}
âœ„
export function getMemoryMaps() {
    var ranges = Process.enumerateRanges("r-x");
    return ranges.filter((range) => {
        if (!range.file)
            return false;
        return true;
    }).map((range) => ({
        name: range.file.path,
        base_address: range.base.toString(),
        protection: range.protection.toString(),
    }));
}
âœ„
{"version":3,"file":"memory.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/memory.ts"],"names":[],"mappings":"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"}
âœ„
export const FrozenValues = new Map();
let currentScanState = null;
const widthFunctions = {
    1: { readUnsigned: 'readU8', writeUnsigned: 'writeU8', readSigned: 'readS8', writeSigned: 'writeS8' },
    2: { readUnsigned: 'readU16', writeUnsigned: 'writeU16', readSigned: 'readS16', writeSigned: 'writeS16' },
    4: { readUnsigned: 'readU32', writeUnsigned: 'writeU32', readSigned: 'readS32', writeSigned: 'writeS32' },
    8: { readUnsigned: 'readU64', writeUnsigned: 'writeU64', readSigned: 'readS64', writeSigned: 'writeS64' }
};
const numberToPattern = (num, width) => {
    const buffer = new ArrayBuffer(width);
    const view = new DataView(buffer);
    switch (width) {
        case 1:
            view.setInt8(0, num);
            break;
        case 2:
            view.setInt16(0, num, true);
            break;
        case 4:
            view.setInt32(0, num, true);
            break;
        case 8:
            view.setBigInt64(0, BigInt(num), true);
            break;
    }
    return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join(' ');
};
const matchInAddresses = (targetValue, addresses, width) => {
    const results = [];
    const readFunction = widthFunctions[width]?.readUnsigned;
    if (!readFunction) {
        throw new Error(`Unsupported width: ${width}`);
    }
    addresses.forEach((addr) => {
        try {
            const value = ptr(addr)[readFunction]();
            if (value === targetValue) {
                results.push(addr);
            }
        }
        catch (e) {
            console.log("Error reading address:", e);
        }
    });
    return results;
};
function scanJS(targetValue, addresses, width = 4) {
    console.log("Initiated scan");
    const results = [];
    const readFunction = widthFunctions[width]?.readUnsigned;
    console.log("Scanning with width:", width);
    if (!readFunction) {
        throw new Error(`Unsupported width: ${width}`);
    }
    const pattern = numberToPattern(targetValue, width);
    if (addresses && addresses?.length > 0) {
        return matchInAddresses(targetValue, addresses, width);
    }
    else {
        Process.enumerateRanges({ protection: "rw-", coalesce: true })
            // TODO: find out more ranges to exclude
            .filter(range => !range.file || !range.file.path.includes('dyld_shared_cache'))
            .forEach((range) => {
            try {
                const size = range.size;
                const baseAddress = range.base;
                const rangeMatches = Memory.scanSync(baseAddress, size, pattern);
                rangeMatches.forEach(match => {
                    results.push(match.address.toString());
                });
            }
            catch (e) {
                console.log("Error scanning range:", e);
            }
        });
    }
    console.log("Scan complete");
    return results;
}
const matches = Memory.alloc(4);
const cm = new CModule(`
    #include <gum/gummemory.h>
    #include "stdio.h"
    #include "glib.h"
    
    extern GArray *matches;

    void init() {
        matches = g_array_new(FALSE, FALSE, sizeof(GumAddress));
    }

    void finalize() {
        g_array_free(matches, TRUE);
    }

    int onMatch(GumAddress address, gsize size, gpointer user_data) {
        g_array_append_val(matches, address);
        return 0;
    }

    void scan(void *range_start, unsigned long range_size, gchar *pattern_string) {
        GumMemoryRange range = {(GumAddress)range_start, range_size};
        GumMatchPattern *pattern = gum_match_pattern_new_from_string(pattern_string);
        gum_memory_scan(&range, pattern, onMatch, NULL);
    }

    int get_matches_length() {
        return matches->len;
    }

    GumAddress get_match_at(int index) {
        return g_array_index(matches, GumAddress, index);
    }
`, { matches });
function scanC(targetValue, addresses, width = 4) {
    if (addresses && addresses?.length > 0) {
        return matchInAddresses(targetValue, addresses, width);
    }
    const scan = new NativeFunction(cm.scan, 'void', ['pointer', 'uint', 'pointer']);
    const getMatchesLength = new NativeFunction(cm.get_matches_length, 'int', []);
    const getMatchAt = new NativeFunction(cm.get_match_at, 'uint64', ['int']);
    const pattern = Memory.allocUtf8String(numberToPattern(targetValue, width));
    const results = [];
    Process.enumerateRanges('rw-').forEach((range) => {
        try {
            scan(range.base, range.size, pattern);
            const length = getMatchesLength();
            for (let i = 0; i < length; i++) {
                results.push(getMatchAt(i).toString(16));
            }
        }
        catch (e) {
            console.log('Error scanning range:', e);
        }
    });
    return results;
}
export function scanStrings(targetValue, addresses) {
    const results = [];
    if (addresses && addresses?.length > 0) {
        return addresses.filter(addr => {
            try {
                const value = ptr(addr).readUtf8String();
                return value?.includes(targetValue) ?? false;
            }
            catch (e) {
                console.log("Error reading address:", e);
                return false;
            }
        });
    }
    const pattern = new MatchPattern(`/${targetValue}/`);
    Process.enumerateRanges('rw-').forEach((range) => {
        try {
            const matches = Memory.scanSync(range.base, range.size, pattern);
            matches.forEach(match => {
                results.push(match.address.toString(16));
            });
        }
        catch (e) {
            console.log('Error scanning range:', e);
        }
    });
    return results;
}
export function firstScan(targetValue, width = 4, signed = false) {
    const results = scanJS(targetValue, [], width);
    currentScanState = {
        addresses: results,
        width,
        signed
    };
    return results.length;
}
export function nextScan(targetValue) {
    if (!currentScanState) {
        throw new Error("No previous scan found. Call firstScan before nextScan.");
    }
    const { addresses, width, signed } = currentScanState;
    const results = scanJS(targetValue, addresses, width);
    currentScanState.addresses = results;
    return results.length;
}
export function getScanResults(page = 1, pageSize = 100) {
    if (!currentScanState) {
        throw new Error("No scan results available. Call firstScan or nextScan first.");
    }
    const { addresses, width, signed } = currentScanState;
    const total = addresses.length;
    const totalPages = Math.ceil(total / pageSize);
    if (page < 1)
        page = 1;
    if (page > totalPages)
        page = totalPages;
    const startIndex = (page - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, total);
    const pageAddresses = addresses.slice(startIndex, endIndex);
    const results = pageAddresses.map(addr => {
        try {
            const value = read(addr, width, signed);
            return { address: addr, value };
        }
        catch (e) {
            console.log(`Error reading address ${addr}:`, e);
            return { address: addr, value: 0 };
        }
    });
    return {
        results,
        total,
        page,
        pageSize,
        totalPages
    };
}
export function clearScanState() {
    currentScanState = null;
}
export function readString(address, maxLength = 256) {
    return ptr(address).readUtf8String(maxLength) ?? '';
}
export function writeString(address, value) {
    ptr(address).writeUtf8String(value);
}
export function read(address, width = 4, signed = false) {
    const readFunction = signed ? widthFunctions[width]?.readSigned : widthFunctions[width]?.readUnsigned;
    if (!readFunction) {
        throw new Error(`Unsupported width: ${width}`);
    }
    return ptr(address)[readFunction]();
}
export function readBytes(address, length) {
    const bytes = ptr(address).readByteArray(length);
    return Array.from(new Uint8Array(bytes));
}
export function writeBytes(address, bytes) {
    ptr(address).writeByteArray(bytes);
}
export function write(address, value, width = 4, signed = false) {
    const writeFunction = signed ? widthFunctions[width]?.writeSigned : widthFunctions[width]?.writeUnsigned;
    if (!writeFunction) {
        throw new Error(`Unsupported width: ${width}`);
    }
    ptr(address)[writeFunction](value);
}
export function freeze(address) {
    console.log("Freezing address:", address);
    // TODO: Fix for width
    const currentValue = read(address, 4);
    FrozenValues.set(address, {
        address,
        value: currentValue,
        width: 4,
        signed: false
    });
}
export function unfreeze(address) {
    console.log("Unfreezing address:", address);
    if (!FrozenValues.has(address)) {
        throw new Error(`Address ${address} is not frozen`);
    }
    FrozenValues.delete(address);
}
export function updateFrozenValue(address, value) {
    const frozen = FrozenValues.get(address);
    if (!frozen) {
        throw new Error(`Address ${address} is not frozen`);
    }
    frozen.value = value;
}
function startFreezeThread() {
    setInterval(() => {
        FrozenValues.forEach((frozen) => {
            try {
                write(frozen.address, frozen.value, frozen.width, frozen.signed);
            }
            catch (e) {
                console.log(`Error writing to frozen address ${frozen.address}:`, e);
                FrozenValues.delete(frozen.address);
            }
        });
    }, 50); // Run every 50ms
}
startFreezeThread();
âœ„
{"version":3,"file":"patch.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/patch.ts"],"names":[],"mappings":"AAAA,MAAM,kBAAkB,GAAiC;IACrD,MAAM,EAAE,EAAE;IACV,KAAK,EAAE,EAAE;IACT,KAAK,EAAE,CAAC;IACR,OAAO,EAAE,CAAC;IACV,MAAM,EAAE,CAAC;CACZ,CAAA;AAED,MAAM,WAAW,GAA8B;IAC3C,MAAM,EAAE,WAAW;IACnB,KAAK,EAAE,WAAW;IAClB,KAAK,EAAE,WAAW;IAClB,OAAO,EAAE,aAAa;IACtB,MAAM,EAAE,YAAY;CACvB,CAAA;AAOD,MAAM,UAAU,KAAK,CAAC,OAAe,EAAE,UAA4B;IAC/D,MAAM,IAAI,GAAG,kBAAkB,CAAC,OAAO,CAAC,IAAoB,CAAC,GAAG,UAAU,CAAC,MAAM,CAAC;IAClF,MAAM,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE;QACxC,MAAM,EAAE,GAAG,IAAI,WAAW,CAAC,OAAO,CAAC,IAAoB,CAAC,EAAE,CAAC;QAC3D,KAAK,MAAM,SAAS,IAAI,UAAU,EAAE;YAChC,sEAAsE;YACtE,EAAE,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC;SAC7C;QACD,EAAE,CAAC,KAAK,EAAE,CAAC;IACf,CAAC,CAAC,CAAC;AACP,CAAC"}
âœ„
const maxInstructionSize = {
    "ia32": 15,
    "x64": 15,
    "arm": 4,
    "arm64": 4,
    "mips": 4,
};
const codeWriters = {
    "ia32": 'X86Writer',
    "x64": 'X86Writer',
    "arm": 'ArmWriter',
    "arm64": 'Arm64Writer',
    "mips": 'MipsWriter',
};
export function patch(address, operations) {
    const size = maxInstructionSize[process.arch] * operations.length;
    Memory.patchCode(ptr(address), size, code => {
        const cw = new codeWriters[process.arch]();
        for (const operation of operations) {
            // Not checking if the method exists, we'll get an error if it doesn't
            cw[operation.method](...operation.values);
        }
        cw.flush();
    });
}
âœ„
{"version":3,"file":"ping.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/ping.ts"],"names":[],"mappings":"AAAA,MAAM,CAAC,MAAM,IAAI,GAAG,GAAY,EAAE;IAC9B,OAAO,IAAI,CAAC;AAChB,CAAC,CAAA"}
âœ„
export const ping = () => {
    return true;
};
âœ„
{"version":3,"file":"register.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/register.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,gBAAgB,CAAC;AAE5C,MAAM,UAAU,YAAY,CAAC,EAAU;IACnC,MAAM,OAAO,GAAG,UAAU,EAAE,CAAC;IAC7B,IAAI,CAAC,OAAO,EAAE;QACV,MAAM,IAAI,KAAK,CAAC,8EAA8E,CAAC,CAAC;KACnG;IACD,MAAM,GAAG,GAAG,OAAO,CAAC,EAA0B,CAAC,CAAC;IAChD,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE;QACzB,OAAO,GAAG,CAAC;KACd;SAAM,IAAI,GAAG,YAAY,aAAa,EAAE;QACrC,OAAO,GAAG,CAAC,QAAQ,EAAE,CAAC;KACzB;SAAM,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;QAC3B,OAAO,GAAG,CAAC;KACd;IACD,MAAM,IAAI,KAAK,CAAC,8BAA8B,OAAO,GAAG,EAAE,CAAC,CAAC;AAChE,CAAC;AAED,MAAM,UAAU,aAAa,CAAC,EAAU,EAAE,KAAiC;IACvE,MAAM,OAAO,GAAG,UAAU,EAAE,CAAC;IAC7B,IAAI,CAAC,OAAO,EAAE;QACV,MAAM,IAAI,KAAK,CAAC,8EAA8E,CAAC,CAAC;KACnG;IACD,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE;QAC3B,OAAO,CAAC,GAAG,CAAC,kBAAkB,KAAK,OAAO,EAAE,EAAE,CAAC,CAAC;QAC/C,OAAO,CAAC,EAA0B,CAAS,GAAG,KAAK,CAAC;KACxD;SAAM,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE;QAClC,OAAO,CAAC,GAAG,CAAC,yBAAyB,KAAK,OAAO,EAAE,EAAE,CAAC,CAAC;QACvD,OAAO,CAAC,EAA0B,CAAC,GAAG,GAAG,CAAC,KAAK,CAAC,CAAC;KACpD;SAAM,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;QAC7B,OAAO,CAAC,GAAG,CAAC,iBAAiB,KAAK,OAAO,EAAE,EAAE,CAAC,CAAC;QAC9C,OAAO,CAAC,EAA0B,CAAS,GAAG,KAAK,CAAC;KACxD;AACL,CAAC"}
âœ„
import { getContext } from "./exception.js";
export function readRegister(id) {
    const context = getContext();
    if (!context) {
        throw new Error("No context found. Make sure to call getContext() when the process is paused.");
    }
    const val = context[id];
    if (typeof val === 'number') {
        return val;
    }
    else if (val instanceof NativePointer) {
        return val.toString();
    }
    else if (Array.isArray(val)) {
        return val;
    }
    throw new Error(`Unsupported register type: ${typeof val}`);
}
export function writeRegister(id, value) {
    const context = getContext();
    if (!context) {
        throw new Error("No context found. Make sure to call getContext() when the process is paused.");
    }
    if (typeof value === 'number') {
        console.log(`Writing number ${value} to ${id}`);
        context[id] = value;
    }
    else if (typeof value === 'string') {
        console.log(`Writing NativePointer ${value} to ${id}`);
        context[id] = ptr(value);
    }
    else if (Array.isArray(value)) {
        console.log(`Writing array ${value} to ${id}`);
        context[id] = value;
    }
}
âœ„
{"version":3,"file":"stoppoint.js","sourceRoot":"/Users/madt1m/labs/freat-server/agent/","sources":["src/stoppoint.ts"],"names":[],"mappings":"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"}
âœ„
export const usedBreakpointSlots = new Map();
export const watchpoints = new Map();
export var StoppointMode;
(function (StoppointMode) {
    StoppointMode["Read"] = "r";
    StoppointMode["Write"] = "w";
    StoppointMode["ReadWrite"] = "rw";
    StoppointMode["Execute"] = "x";
})(StoppointMode || (StoppointMode = {}));
export function addStoppoint(address, mode, size = 1) {
    if (mode === StoppointMode.Execute) {
        return addBreakpoint(address);
    }
    else {
        return addWatchpoint(address, mode, size);
    }
}
function findFirstAvailableSlot(usedSlots) {
    let slot = 0;
    while (usedSlots.includes(slot)) {
        slot++;
    }
    return slot;
}
function addWatchpoint(address, mode, size) {
    console.log(`Adding watchpoint at ${address} with mode ${mode} and size ${size}`);
    const usedSlots = Array.from(watchpoints.values()).map(info => info.slot);
    const slot = findFirstAvailableSlot(usedSlots);
    const thread = Process.enumerateThreads()[0];
    thread.setHardwareWatchpoint(slot, ptr(address), size, mode);
    watchpoints.set(ptr(address).toString(), {
        mode,
        size,
        slot
    });
    console.log(`Watchpoint added using slot ${slot} and info ${JSON.stringify(watchpoints.get(ptr(address).toString()))}`);
    console.log(`Watchpoints: ${JSON.stringify(Object.fromEntries(watchpoints))}`);
    return slot;
}
function addBreakpoint(address) {
    console.log(`Adding breakpoint at ${address}`);
    const usedSlots = Array.from(usedBreakpointSlots.values());
    const slot = findFirstAvailableSlot(usedSlots);
    const thread = Process.enumerateThreads()[0];
    thread.setHardwareBreakpoint(slot, ptr(address));
    usedBreakpointSlots.set(ptr(address).toString(), slot);
    console.log(`Breakpoint added using register slot ${slot}`);
    return slot;
}
export function removeStoppoint(address, mode) {
    console.log(`Removing stoppoint at ${address}`);
    if (!usedBreakpointSlots.has(ptr(address).toString())) {
        throw new Error(`No breakpoint exists at ${address}`);
    }
    if (mode === StoppointMode.Execute) {
        removeBreakpoint(address);
    }
    else {
        removeWatchpoint(address);
    }
}
export function removeBreakpoint(address) {
    const thread = Process.enumerateThreads()[0];
    for (const [addr, slot] of usedBreakpointSlots.entries()) {
        if (addr == address) {
            console.log(`Removing breakpoint at ${addr} using slot ${slot}`);
            thread.unsetHardwareBreakpoint(slot);
            usedBreakpointSlots.delete(addr);
            break;
        }
    }
    console.log(`Breakpoint removed and slot freed`);
}
export function removeWatchpoint(address) {
    const thread = Process.enumerateThreads()[0];
    const info = watchpoints.get(address);
    if (info) {
        thread.unsetHardwareWatchpoint(info.slot);
        watchpoints.delete(address);
    }
    console.log(`Watchpoint removed and slot freed`);
}